<?php

	$executionStartTime = microtime(true) / 1000;
	//API call

	$alpha2['AFG']['A2']="AF"; 
	$alpha2['ALA']['A2']="AX"; 
	$alpha2['ALB']['A2']="AL"; 
	$alpha2['DZA']['A2']="DZ"; 
	$alpha2['ASM']['A2']="AS"; 
	$alpha2['AGO']['A2']="AO"; 
	$alpha2['ATA']['A2']="AQ";
	$alpha2['ARG']['A2']="AR"; 
	$alpha2['ARM']['A2']="AM"; 
	$alpha2['AUS']['A2']="AU"; 
	$alpha2['AUT']['A2']="AT"; 
	$alpha2['AZE']['A2']="AZ"; 
	$alpha2['BHS']['A2']="BS"; 
	$alpha2['BHR']['A2']="BH"; 
	$alpha2['BGD']['A2']="BD"; 
	$alpha2['BLR']['A2']="BY"; 
	$alpha2['BEL']['A2']="BE"; 
	$alpha2['BEN']['A2']="BJ"; 
	$alpha2['BMU']['A2']="BM"; 
	$alpha2['BTN']['A2']="BT"; 
	$alpha2['BOL']['A2']="BO"; 
	$alpha2['BES']['A2']="BQ"; 
	$alpha2['BIH']['A2']="BA"; 
	$alpha2['BWA']['A2']="BW"; 
	$alpha2['BRA']['A2']="BR"; 
	$alpha2['BRN']['A2']="BN"; 
	$alpha2['BGR']['A2']="BG"; 
	$alpha2['BFA']['A2']="BF"; 
	$alpha2['BDI']['A2']="BI"; 
	$alpha2['KHM']['A2']="KH"; 
	$alpha2['CMR']['A2']="CM"; 
	$alpha2['CAN']['A2']="CA"; 
	$alpha2['CAF']['A2']="CF"; 
	$alpha2['TCD']['A2']="TD"; 
	$alpha2['CHL']['A2']="CL"; 
	$alpha2['CHN']['A2']="CN";
	$alpha2['COL']['A2']="CO";
	$alpha2['COG']['A2']="CG"; 
	$alpha2['COD']['A2']="CD"; 
	$alpha2['CRI']['A2']="CR"; 
	$alpha2['CIV']['A2']="CI"; 
	$alpha2['HRV']['A2']="HR"; 
	$alpha2['CUB']['A2']="CU"; 
	$alpha2['CUW']['A2']="CW"; 
	$alpha2['CYP']['A2']="CY"; 
	$alpha2['CZE']['A2']="CZ";
	$alpha2['DNK']['A2']="DK";
	$alpha2['DJI']['A2']="DJ"; 
	$alpha2['DMA']['A2']="DM"; 
	$alpha2['DOM']['A2']="DO"; 
	$alpha2['ECU']['A2']="EC"; 
	$alpha2['EGY']['A2']="EG"; 
	$alpha2['SLV']['A2']="SV"; 
	$alpha2['GNQ']['A2']="GQ";
	$alpha2['ERI']['A2']="ER"; 
	$alpha2['EST']['A2']="EE"; 
	$alpha2['ETH']['A2']="ET"; 
	$alpha2['FLK']['A2']="FK"; 
	$alpha2['FJI']['A2']="FJ"; 
	$alpha2['FIN']['A2']="FI"; 
	$alpha2['FRA']['A2']="FR"; 
	$alpha2['GUF']['A2']="GF"; 
	$alpha2['ATF']['A2']="TF"; 
	$alpha2['GAB']['A2']="GA"; 
	$alpha2['GMB']['A2']="GM"; 
	$alpha2['GEO']['A2']="GE"; 
	$alpha2['DEU']['A2']="DE"; 
	$alpha2['GHA']['A2']="GH"; 
	$alpha2['GRC']['A2']="GR"; 
	$alpha2['GRL']['A2']="GL"; 
	$alpha2['GTM']['A2']="GT"; 
	$alpha2['GIN']['A2']="GN"; 
	$alpha2['GNB']['A2']="GW"; 
	$alpha2['GUY']['A2']="GY"; 
	$alpha2['HTI']['A2']="HT"; 
	$alpha2['HND']['A2']="HN"; 
	$alpha2['HUN']['A2']="HU"; 
	$alpha2['ISL']['A2']="IS";
	$alpha2['IND']['A2']="IN"; 
	$alpha2['IDN']['A2']="ID"; 
	$alpha2['IRN']['A2']="IR"; 
	$alpha2['IRQ']['A2']="IQ"; 
	$alpha2['IRL']['A2']="IE"; 
	$alpha2['ISR']['A2']="IL";
	$alpha2['ITA']['A2']="IT"; 
	$alpha2['JAM']['A2']="JM";
	$alpha2['JPN']['A2']="JP"; 
	$alpha2['JOR']['A2']="JO";
	$alpha2['KAZ']['A2']="KZ"; 
	$alpha2['KEN']['A2']="KE"; 
	$alpha2['PRK']['A2']="KP";
	$alpha2['KOR']['A2']="KR";
	$alpha2['KWT']['A2']="KW"; 
	$alpha2['KGZ']['A2']="KG"; 
	$alpha2['LAO']['A2']="LA"; 
	$alpha2['LVA']['A2']="LV";
	$alpha2['LBN']['A2']="LB"; 
	$alpha2['LSO']['A2']="LS";
	$alpha2['LBR']['A2']="LR"; 
	$alpha2['LBY']['A2']="LY"; 
	$alpha2['LIE']['A2']="LI"; 
	$alpha2['LTU']['A2']="LT"; 
	$alpha2['LUX']['A2']="LU"; 
	$alpha2['MKD']['A2']="MK"; 
	$alpha2['MDG']['A2']="MG"; 
	$alpha2['MWI']['A2']="MW"; 
	$alpha2['MYS']['A2']="MY"; 
	$alpha2['MDV']['A2']="MV";
	$alpha2['MLI']['A2']="ML"; 
	$alpha2['MLT']['A2']="MT"; 
	$alpha2['MRT']['A2']="MR"; 
	$alpha2['MEX']['A2']="MX"; 
	$alpha2['MDA']['A2']="MD";
	$alpha2['MCO']['A2']="MC"; 
	$alpha2['MNG']['A2']="MN"; 
	$alpha2['MAR']['A2']="MA"; 
	$alpha2['MOZ']['A2']="MZ"; 
	$alpha2['MMR']['A2']="MM"; 
	$alpha2['NAM']['A2']="NA"; 
	$alpha2['NPL']['A2']="NP"; 
	$alpha2['NLD']['A2']="NL";
	$alpha2['NCL']['A2']="NC"; 
	$alpha2['NZL']['A2']="NZ"; 
	$alpha2['NIC']['A2']="NI"; 
	$alpha2['NER']['A2']="NE"; 
	$alpha2['NGA']['A2']="NG"; 
	$alpha2['NOR']['A2']="NO";
	$alpha2['OMN']['A2']="OM"; 
	$alpha2['PAK']['A2']="PK"; 
	$alpha2['PAN']['A2']="PA";
	$alpha2['PNG']['A2']="PG"; 
	$alpha2['PRY']['A2']="PY";
	$alpha2['PER']['A2']="PE"; 
	$alpha2['PHL']['A2']="PH"; 
	$alpha2['POL']['A2']="PL";
	$alpha2['PRT']['A2']="PT"; 
	$alpha2['PRI']['A2']="PR"; 
	$alpha2['QAT']['A2']="QA"; 
	$alpha2['ROU']['A2']="RO"; 
	$alpha2['RUS']['A2']="RU"; 
	$alpha2['RWA']['A2']="RW"; 
	$alpha2['SAU']['A2']="SA"; 
	$alpha2['SEN']['A2']="SN"; 
	$alpha2['SRB']['A2']="RS"; 
	$alpha2['SLE']['A2']="SL"; 
	$alpha2['SGP']['A2']="SG"; 
	$alpha2['SVK']['A2']="SK"; 
	$alpha2['SVN']['A2']="SI"; 
	$alpha2['SLB']['A2']="SB"; 
	$alpha2['SOM']['A2']="SO"; 
	$alpha2['ZAF']['A2']="ZA"; 
	$alpha2['SSD']['A2']="SS"; 
	$alpha2['ESP']['A2']="ES"; 
	$alpha2['LKA']['A2']="LK"; 
	$alpha2['SDN']['A2']="SD"; 
	$alpha2['SUR']['A2']="SR"; 
	$alpha2['SWZ']['A2']="SZ"; 
	$alpha2['SWE']['A2']="SE"; 
	$alpha2['CHE']['A2']="CH"; 
	$alpha2['SYR']['A2']="SY"; 
	$alpha2['TWN']['A2']="TW"; 
	$alpha2['TJK']['A2']="TJ"; 
	$alpha2['TZA']['A2']="TZ"; 
	$alpha2['THA']['A2']="TH"; 
	$alpha2['TLS']['A2']="TL";
	$alpha2['TGO']['A2']="TG"; 
	$alpha2['TTO']['A2']="TT"; 
	$alpha2['TUN']['A2']="TN"; 
	$alpha2['TUR']['A2']="TR"; 
	$alpha2['TKM']['A2']="TM"; 
	$alpha2['UGA']['A2']="UG"; 
	$alpha2['UKR']['A2']="UA"; 
	$alpha2['ARE']['A2']="AE"; 
	$alpha2['GBR']['A2']="GB"; 
	$alpha2['USA']['A2']="US"; 
	$alpha2['URY']['A2']="UY"; 
	$alpha2['UZB']['A2']="UZ"; 
	$alpha2['VUT']['A2']="VU"; 
	$alpha2['VEN']['A2']="VE"; 
	$alpha2['VNM']['A2']="VN"; 
	$alpha2['ESH']['A2']="EH"; 
	$alpha2['YEM']['A2']="YE"; 
	$alpha2['ZMB']['A2']="ZM"; 
	$alpha2['ZWE']['A2']="ZW"; 
	
	function getData($url) {
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_URL,$url);

		$data=curl_exec($ch);

		curl_close($ch);
		if ($data != null) {
			return $data;
			}	
	}

	//read country's boundary from json file
	$str = file_get_contents('../../countries_small.geo.json');
	$json = json_decode($str, true);

	$result['type'] = "FeatureCollection";

	foreach ($json['features'] as $country) {
		if ($country['id'] == $_REQUEST['country']) {
			$result['feature'] = $country;
		}
	}

	//to get info about the country
	$url1='https://restcountries.eu/rest/v2/alpha/'.$_REQUEST['country'];
	$decode1 = json_decode(getData($url1),true);
	//to get Covid-19 info about the country
	$url2= 'https://covid-19-data.herokuapp.com/api/cases/'.$_REQUEST['country'];
	$decode2 = json_decode(getData($url2),true);
	//to get weather info about the country
	$url3= 'https://api.openweathermap.org/data/2.5/onecall?lat='.$decode1['latlng'][0].'&lon='.$decode1['latlng'][1].'&appid=e6bd8c59fa20a6340744097a43feca6b';
	$decode3 = json_decode(getData($url3),true);

	$url4= 'http://api.geonames.org/searchJSON?country='.$alpha2[$_REQUEST['country']]['A2'].'&cities=cities15000&maxRows=10&username=gradian';
	$decode4 = json_decode(getData($url4),true);

	//save data to $result
	$result['feature']['properties']['latlng'] = $decode1['latlng'];
	$result['feature']['properties']['capital'] = $decode1['capital'];
	$result['feature']['properties']['region'] = $decode1['region'];
	$result['feature']['properties']['flag'] = $decode1['flag'];
	$result['feature']['properties']['area'] = $decode1['area'];
	$result['feature']['properties']['population'] = $decode1['population'];
	$result['feature']['properties']['cases'] = $decode2['data']['cases']['infections'];
	$result['feature']['properties']['deaths'] = $decode2['data']['cases']['deaths'];
	$result['feature']['properties']['rate'] = $decode2['data']['cases']['mortalityRate'];
	for ($x = 1; $x <= 5; $x++) {
		$result['feature']['properties']['date'][$x] = $decode3['daily'][$x]['dt'];
		$result['feature']['properties']['temp'][$x] = $decode3['daily'][$x]['temp']['day'];
		$result['feature']['properties']['windSpeed'][$x] = $decode3['daily'][$x]['wind_speed'];
		$result['feature']['properties']['weather'][$x] = $decode3['daily'][$x]['weather'][0]['main'];
	  };
	
	$result['feature']['properties']['cities'] = $decode4['geonames'];

	$output['status']['code'] = "200";
	$output['status']['name'] = "ok";
	$output['status']['description'] = "mission saved";
	$output['status']['returnedIn'] = (microtime(true) - $executionStartTime) / 1000 . " ms";
	$output['data'] = $result;

	header('Content-Type: application/json; charset=UTF-8');
	//send back data to javascript 
	echo json_encode($result);

?>
